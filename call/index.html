<!DOCTYPE html>
<html lang="en">
<head>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://tracking.managemoney101.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-KQ4R2LKP');</script>

    <script>
    var head = document.head;
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = "https://t.managemoney101.com/v1/lst/universal-script?ph=99701b257ae8a5117ba5d7b516261da603bc86a49c0c42f398c619e251026c05&tag=!clicked&ref_url=" + encodeURI(document.URL) ;
    head.appendChild(script);
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule a Call</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: Arial, sans-serif;
        }
        #SOIDIV_3DayChallengeConsultation {
            min-width: 290px;
            max-width: 900px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <!-- ScheduleOnce inline embed START -->
    <div id="SOIDIV_3DayChallengeConsultation" data-so-page="3DayChallengeConsultation" data-height="580" data-style="border: none; min-width: 290px; max-width: 900px;"></div>
    <script type="text/javascript" src="https://cdn.oncehub.com/mergedjs/so.js"></script>
    <!-- ScheduleOnce inline embed END -->

    <!-- Redirect to ClickFunnels after booking -->
    <script>
    window.addEventListener('message', function(event) {
        // Log all postMessages for debugging (remove after testing)
        console.log('postMessage received:', event.origin, event.data);

        // Accept messages from OnceHub or ScheduleOnce
        if (event.origin.indexOf('oncehub.com') === -1 && event.origin.indexOf('scheduleonce.com') === -1) return;

        try {
            var data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
            console.log('Parsed OnceHub data:', data);

            // Check for booking confirmation event - try multiple possible event names
            var isBookingEvent = data && (
                data.action === 'scheduled' ||
                data.action === 'booked' ||
                data.action === 'confirmed' ||
                data.event === 'booking_created' ||
                data.event === 'scheduled' ||
                data.event === 'booked' ||
                data.type === 'booking_confirmed' ||
                data.type === 'scheduled' ||
                data.bookingCreated ||
                data.scheduled ||
                (data.message && data.message.indexOf('scheduled') !== -1) ||
                (data.message && data.message.indexOf('booked') !== -1)
            );

            if (isBookingEvent) {
                var customerEmail = data.email || data.customer_email || (data.data && data.data.email) || '';
                var customerName = data.name || data.customer_name || (data.data && data.data.name) || '';
                var customerPhone = data.phone || data.mobile_phone || data.customer_mobile_phone || (data.data && data.data.mobile_phone) || '';

                // Fire conversion event for GTM/HighLevel/Facebook
                window.dataLayer = window.dataLayer || [];
                window.dataLayer.push({
                    'event': 'booking_complete',
                    'event_category': 'scheduling',
                    'event_action': 'call_booked',
                    'customer_email': customerEmail,
                    'customer_name': customerName,
                    'customer_phone': customerPhone
                });

                var email = encodeURIComponent(customerEmail);
                var name = encodeURIComponent(customerName);
                var phone = encodeURIComponent(customerPhone);

                var redirectUrl = 'https://www.managemoney101.com/callconfirmation?email=' + email + '&name=' + name + '&phone=' + phone;

                // Pass through UTM parameters
                var urlParams = new URLSearchParams(window.location.search);
                var utmParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'];
                utmParams.forEach(function(param) {
                    var value = urlParams.get(param);
                    if (value) redirectUrl += '&' + param + '=' + encodeURIComponent(value);
                });

                // Pass through Facebook click ID
                var fbclid = urlParams.get('fbclid');
                if (fbclid) redirectUrl += '&fbclid=' + encodeURIComponent(fbclid);

                // Pass through Facebook cookies if available
                var getCookie = function(name) {
                    var match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
                    return match ? match[2] : null;
                };
                var fbp = getCookie('_fbp');
                var fbc = getCookie('_fbc');
                if (fbp) redirectUrl += '&_fbp=' + encodeURIComponent(fbp);
                if (fbc) redirectUrl += '&_fbc=' + encodeURIComponent(fbc);

                // Small delay to allow tracking events to fire before redirect
                setTimeout(function() {
                    window.location.href = redirectUrl;
                }, 500);
            }
        } catch (e) {
            // Not a JSON message, ignore
        }
    });
    </script>
</body>
</html>
